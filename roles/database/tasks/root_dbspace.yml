---

- name: "{{ informix_server_name }} : {{ dbspace.key }} : Check initial chunk configuration for root dbspace is present"
  assert:
    that:
      - dbspace.value.initial_chunk is defined
    msg: "Configuration for dbspace '{{ dbspace.key }}' must include 'initial_chunk' configuration"

- name: "{{ informix_server_name }} : {{ dbspace.key }} : Resolve path of root dbspace initial chunk"
  command: "realpath {{ dbspace.value.initial_chunk.path }}"
  register: initial_chunk_path

- name: "{{ informix_server_name }} : {{ dbspace.key }} : Check state of root dbspace initial chunk"
  stat:
    path: "{{ initial_chunk_path.stdout }}"
  register: root_chunk_state

- name: "{{ informix_server_name }} : {{ dbspace.key }} : Create cooked file root dbspace initial chunk"
  file:
    path: "{{ dbspace.value.initial_chunk.path }}"
    owner: informix
    group: informix
    mode: 0660
    state: touch
  when: root_chunk_state.stat.ischr is not defined or root_chunk_state.stat.ischr == False

- name: "{{ informix_server_name }} : {{ dbspace.key }} : Enable disk initialisation for dbspace provisioning"
  lineinfile:
    path: "{{ informix_install_path }}/etc/onconfig.{{ informix_server_name }}"
    state: present
    regexp: '^(FULL_DISK_INIT).*'
    line: '\1 1'
    backrefs: yes

- name: "{{ informix_server_name }} : {{ dbspace.key }} : Initialise root dbspace"
  become_user: "{{ informix_server_name }}"
  shell: "source {{ informix_env_file_path }} && oninit -i -y"
  args:
    executable: /bin/bash

- name: "{{ informix_server_name }} : {{ dbspace.key }} : Provision additional root dbspace chunks"
  include_tasks: chunk.yml
  loop: "{{ dbspace.value.additional_chunks }}"
  loop_control:
    loop_var: chunk
  when: dbspace.value.additional_chunks is defined and dbspace.value.additional_chunks | length > 0
